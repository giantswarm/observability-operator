# This file was generated by observability-operator.
# It configures Alloy to be used as events logger.
# - configMap is generated from events-logger.alloy.template and passed as a string
#   here and will be created by Alloy's chart.
# - Alloy runs as a deployment, with only 1 replica.
networkPolicy:
  cilium:
    egress:
    - toEntities:
      - kube-apiserver
      - world
    # Allow direct access to loki-gateway
    - toEndpoints:
      - matchLabels:
          app.kubernetes.io/component: gateway
          app.kubernetes.io/name: loki
          io.kubernetes.pod.namespace: loki
      toPorts:
      - ports:
        - port: "8080"
          protocol: TCP
    - toEndpoints:
      - matchLabels:
          k8s-app: coredns
      - matchLabels:
          k8s-app: k8s-dns-node-cache
      toPorts:
      - ports:
        - port: "53"
          protocol: ANY
        - port: "1053"
          protocol: ANY
        rules:
          dns:
            - matchPattern: '*'
    - toEndpoints:
      - matchLabels:
          app.kubernetes.io/name: ingress-nginx
      toPorts:
      - ports:
        - port: "80"
          protocol: ANY
        - port: "443"
          protocol: ANY
    - toEndpoints:
      - matchLabels:
          app.kubernetes.io/instance: alloy-events
          app.kubernetes.io/name: alloy
      toPorts:
      - ports:
        - port: "12345"
          protocol: TCP
alloy:
  alloy:
    configMap:
      create: true
      content: |-
        logging {
        	level  = "info"
        	format = "logfmt"
        }
        remote.kubernetes.secret "credentials" {
        	namespace = "kube-system"
        	name = "alloy-events"
        }
        loki.source.kubernetes_events "local" {
        	namespaces = []
        	forward_to = [loki.write.default.receiver]
        }
        // Loki target configuration
        loki.write "default" {
        	endpoint {
        		max_backoff_period = "10m"
        		remote_timeout     = "60s"
        		tenant_id          = convert.nonsensitive(remote.kubernetes.secret.credentials.data["logging-tenant-id"])
        		url                = "http://loki-gateway.loki.svc:80/loki/api/v1/push"
        		tls_config {
        			insecure_skip_verify = false
        		}
        	}
        	external_labels = {
        		cluster_id       = "test-installation",
        		cluster_type     = "management_cluster",
        		organization     = "test-organization",
        		provider         = "capa",
        		scrape_job       = "kubernetes-events",
        	}
        }
    # We decided to configure the alloy-events resources as such after some investigation done https://github.com/giantswarm/giantswarm/issues/32655
    # We also updated the alloy-events CPU request and limits here https://github.com/giantswarm/giantswarm/issues/34619 to avoid CPU throttling
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 50m
        memory: 128Mi
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      readOnlyRootFilesystem: false
      runAsUser: 10
      runAsGroup: 10
      runAsNonRoot: true
      seccompProfile:
        type: RuntimeDefault
  controller:
    type: deployment
    replicas: 1
  crds:
    create: false
verticalPodAutoscaler:
  enabled: true
  # We decided to configure the alloy-events vertical pod autoscaler as such after some investigation done https://github.com/giantswarm/giantswarm/issues/32655
  resourcePolicy:
    containerPolicies:
    - containerName: alloy
      controlledResources:
      - memory
      controlledValues: "RequestsAndLimits"
