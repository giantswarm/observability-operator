# This file was generated by observability-operator.
# It configures Alloy for network monitoring.
# - configMap is generated from logging.alloy.template and passed as a string
#   here and will be created by Alloy's chart.
# - Alloy runs as a daemonset, with required tolerations in order to scrape logs
#   from every machine in the cluster.
# - Running as root user is required in order to be able to read log files within
#   /run/log/journal directories.
# - NODE_NAME env var is used as additional label for kubernetes_audit logs.
networkPolicy:
  cilium:
    egress:
    - toEntities:
      - kube-apiserver
      - world
    # Allow DNS resolution
    - toEndpoints:
      - matchLabels:
          io.kubernetes.pod.namespace: kube-system
          k8s-app: coredns
      - matchLabels:
          io.kubernetes.pod.namespace: kube-system
          k8s-app: k8s-dns-node-cache
      toPorts:
      - ports:
        - port: "1053"
          protocol: UDP
        - port: "1053"
          protocol: TCP
        - port: "53"
          protocol: UDP
        - port: "53"
          protocol: TCP
  endpointSelector:
    matchLabels:
      app.kubernetes.io/instance: alloy-logs
      app.kubernetes.io/name: alloy

alloy:
  alloy:
    configMap:
      create: true
      content: |-
        logging {
        	level  = "warn"
        	format = "logfmt"
        }
        remote.kubernetes.secret "credentials" {
        	namespace = "kube-system"
        	name = "alloy-logs"
        }
        beyla.ebpf "default" {
        	attributes {
        		kubernetes {
        			cluster_name = "test-cluster"
        			enable = "true"
        		}
        		select {
        			attr = "beyla_network_flow_bytes"
        			include = [
        				"k8s.src.namespace",
        				"k8s.src.name",
        				"k8s.src.type",
        				"k8s.dst.namespace",
        				"k8s.dst.name",
        				"k8s.dst.type",
        				"src.cidr",
        				"src.address",
        				"src.name",
        				"dst.cidr",
        				"dst.address",
        				"src.zone",
        				"dst.zone",
        				"dst.name",
        				"transport",
        				"direction",
        			]
        		}
        	}
        	filters {
        		network {
        			attr = "direction"
        			match = "request"
        		}
        	}
        	metrics {
        		features = [
        			"network",
        			"network_inter_zone",
        		]
        	}
        }
    # We decided to configure the alloy-logs resources as such after some investigation done https://github.com/giantswarm/giantswarm/issues/32655
    resources:
      limits:
        cpu: 2000m
        memory: 300Mi
      requests:
        cpu: 25m
        memory: 200Mi
    securityContext:
      allowPrivilegeEscalation: true
      appArmorProfile:
        type: Unconfined
      capabilities:
        add:
        - BPF
        - CHECKPOINT_RESTORE
        - DAC_READ_SEARCH
        - NET_RAW
        - NET_ADMIN
        - PERFMON
        - SYS_PTRACE
        - SYS_RESOURCE
        - SYS_ADMIN
        drop: []
      privileged: true
      readOnlyRootFilesystem: true
      runAsUser: 0
      runAsGroup: 0
      runAsNonRoot: false
      seccompProfile:
        type: Unconfined
  controller:
    type: daemonset
    hostPID: true
    hostNetwork: true
    priorityClassName: giantswarm-critical
    tolerations:
    - effect: NoSchedule
      key: node-role.kubernetes.io/master
      operator: Exists
    - effect: NoSchedule
      key: node-role.kubernetes.io/control-plane
      operator: Exists
    volumes:
      extra:
      - name: runlogjournal
        hostPath:
          path: /run/log/journal
      - name: alloy-tmp
        emptyDir: {}
  image:
    tag: v1.12.0
  extraObjects:
  - apiVersion: monitoring.coreos.com/v1
    kind: ServiceMonitor
    metadata:
      labels:
        observability.giantswarm.io/tenant: giantswarm
      name: alloy-logs-beyla
      namespace: kube-system
    spec:
      endpoints:
      - honorLabels: true
        port: http-metrics
        path: /api/v0/component/beyla.ebpf.default/metric
        scheme: http
      selector:
        matchLabels:
          app.kubernetes.io/instance: alloy-logs
          app.kubernetes.io/name: alloy

verticalPodAutoscaler:
  enabled: true
  # We decided to configure the alloy-logs vertical pod autoscaler as such after some investigation done https://github.com/giantswarm/giantswarm/issues/32655
  resourcePolicy:
    containerPolicies:
    - containerName: alloy
      controlledResources:
      - memory
      controlledValues: "RequestsAndLimits"
      maxAllowed:
        memory: 1Gi
kyvernoPolicyExceptions:
  enabled: true
  namespace: giantswarm
  exceptions:
  - policyName: restrict-volume-types
    ruleNames:
    - "*"
  - policyName: always-allow-heartbeats-and-all-pipelines-alerts
    ruleNames:
    - "*"
  - policyName: block-k8s-initiator-app-deployment-capa
    ruleNames:
    - "*"
  - policyName: disallow-capabilities
    ruleNames:
    - "*"
  - policyName: disallow-capabilities-strict
    ruleNames:
    - "*"
  - policyName: disallow-host-namespaces
    ruleNames:
    - "*"
  - policyName: disallow-host-path
    ruleNames:
    - "*"
  - policyName: disallow-host-ports
    ruleNames:
    - "*"
  - policyName: disallow-host-process
    ruleNames:
    - "*"
  - policyName: disallow-noisy-policy-contexts
    ruleNames:
    - "*"
  - policyName: disallow-privilege-escalation
    ruleNames:
    - "*"
  - policyName: disallow-privileged-containers
    ruleNames:
    - "*"
  - policyName: disallow-proc-mount
    ruleNames:
    - "*"
  - policyName: disallow-selinux
    ruleNames:
    - "*"
  - policyName: require-emptydir-requests-and-limits
    ruleNames:
    - "*"
  - policyName: require-run-as-non-root-user
    ruleNames:
    - "*"
  - policyName: require-run-as-nonroot
    ruleNames:
    - "*"
  - policyName: restrict-apparmor-profiles
    ruleNames:
    - "*"
  - policyName: restrict-polex-namespaces
    ruleNames:
    - "*"
  - policyName: restrict-policy-kind-wildcards
    ruleNames:
    - "*"
  - policyName: restrict-seccomp
    ruleNames:
    - "*"
  - policyName: restrict-seccomp-strict
    ruleNames:
    - "*"
  - policyName: restrict-sysctls
    ruleNames:
    - "*"
  - policyName: restrict-volume-types
    ruleNames:
    - "*"
